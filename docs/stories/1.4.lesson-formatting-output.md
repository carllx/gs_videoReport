# Story 1.4: 教案格式化与文件输出

## Status

**✅ Completed (v2.2)** - 多模板支持，模板子文件夹组织，Obsidian兼容

## Story

**As a** 艺术领域教师,
**I want** 将分析后的视频内容格式化成结构化的Markdown教案并保存到本地,
**so that** 我能获得一个最终可用的、包含时间戳的高质量教学材料

## Acceptance Criteria

1. API 返回的内容被正确地填入一个标准的 Markdown 教案模板中
2. 生成的教案中包含了基于分析的、可点击的精确 YouTube 时间戳
3. Markdown 文件的顶部包含了与 Obsidian Dataview 兼容的元数据（YAML Frontmatter）
4. 最终的 `.md` 文件被成功保存到本地文件系统
5. 用户可以通过命令行参数指定文件的输出路径
6. 程序成功执行后，会在终端显示成功信息及产出文件的路径
7. 支持自定义教案模板和样式配置
8. 生成的文件名包含视频标题和时间戳信息

## Tasks / Subtasks

- [ ] 设计教案模板系统 (AC: 1, 7)
  - [ ] 创建基础 Markdown 教案模板
  - [ ] 实现模板变量替换逻辑
  - [ ] 支持自定义模板加载和选择
  - [ ] 添加模板验证和错误处理

- [ ] 时间戳格式化和链接生成 (AC: 2)
  - [ ] 实现 YouTube 时间戳链接生成（&t=123s 格式）
  - [ ] 格式化时间显示（MM:SS 或 HH:MM:SS）
  - [ ] 创建可点击的时间戳链接
  - [ ] 验证时间戳准确性和可访问性

- [ ] Obsidian Dataview 元数据生成 (AC: 3)
  - [ ] 设计 YAML Frontmatter 结构
  - [ ] 添加视频元信息（标题、作者、时长等）
  - [ ] 包含分析相关的标签和分类
  - [ ] 支持自定义元数据字段

- [ ] 文件输出和保存管理 (AC: 4, 5, 8)
  - [ ] 实现本地文件写入逻辑
  - [ ] 支持用户指定输出路径
  - [ ] 创建智能文件命名规则
  - [ ] 处理文件冲突和覆盖策略

- [ ] 用户反馈和成功确认 (AC: 6)
  - [ ] 显示文件保存成功消息
  - [ ] 提供完整的输出文件路径
  - [ ] 添加文件大小和处理时间信息
  - [ ] 支持打开文件位置的快捷操作

- [ ] 内容结构化和格式优化 (AC: 1)
  - [ ] 解析 API 返回的结构化内容
  - [ ] 实现章节和子章节自动分级
  - [ ] 格式化代码块、引用和列表
  - [ ] 优化 Markdown 语法和可读性

## Dev Notes

**项目技术背景:**

- 需要处理复杂的 Markdown 文档生成和格式化
- 要求与 Obsidian Dataview 插件完全兼容
- 支持灵活的模板系统和用户自定义
- 文件操作需要健壮的错误处理

**架构要求:**

- 模板引擎与业务逻辑分离
- 可扩展的元数据系统
- 灵活的文件命名和路径管理
- 支持多种输出格式的扩展性

**关键技术点:**

- Markdown 文档结构化生成
- YAML Frontmatter 动态创建
- YouTube 时间戳 URL 格式化
- 文件系统操作和路径处理
- 模板引擎集成和变量替换

**具体技术实现要求:**

- 模板引擎：使用 Jinja2 或内置 string.Template
- 文件操作：pathlib 进行路径处理
- 元数据格式：YAML Frontmatter 标准
- 时间戳格式：`https://www.youtube.com/watch?v={video_id}&t={seconds}s`
- 文件编码：UTF-8 确保中文支持

**教案模板结构:**
```markdown
---
title: "{{ video_title }}"
author: "{{ video_author }}"
duration: "{{ video_duration }}"
source_url: "{{ video_url }}"
created_date: "{{ creation_date }}"
tags: {{ tags_list }}
---

# {{ lesson_title }}

## 视频信息
- **标题**: {{ video_title }}
- **时长**: {{ video_duration }}
- **来源**: [{{ video_url }}]({{ video_url }})

## 内容概览
{{ content_summary }}

## 详细内容

{% for section in content_sections %}
### {{ section.title }}
{{ section.content }}

**关键时间点**: [{{ section.timestamp_display }}]({{ section.timestamp_url }})
{% endfor %}
```

### Testing

**测试标准:**

- 单元测试覆盖模板引擎和变量替换
- 文件生成和保存功能测试
- YAML Frontmatter 格式验证测试
- 时间戳链接有效性测试
- Obsidian Dataview 兼容性验证
- 多种输出路径和文件命名场景测试
- 测试文件位置：`tests/test_lesson_formatter.py`
- 使用临时目录进行文件操作测试
- 包含 Unicode 和特殊字符处理测试

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation for lesson formatting and file output functionality | Sarah (PO) |

## Dev Agent Record

This section will be populated by the development agent during implementation

### Agent Model Used

To be filled by dev agent

### Debug Log References

To be filled by dev agent

### Completion Notes List

To be filled by dev agent

### File List

To be filled by dev agent

## QA Results

Results from QA Agent review will be populated here
